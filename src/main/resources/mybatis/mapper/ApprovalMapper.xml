<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loung.semof.approval.dao.ApprovalMapper">

    <resultMap type="com.loung.semof.approval.dto.ApprovLineDTO" id="lineResultMap">
        <id property="lineNo" column="LINE_NO"/>
        <result property="lineName" column="LINE_NAME"/>
        <result property="empName" column="EMP_NAME"/>
        <result property="empNo" column="EMP_NO"/>
        <result property="branchCode" column="BRANCH_CODE"/>
        <collection property="approvOrderDTOList" resultMap="orderResultMap"/>
    </resultMap>
    <resultMap id="orderResultMap" type="com.loung.semof.approval.dto.ApprovOrderDTO">
        <id property="orderNo" column="ORDER_NO"/>
        <result property="lineNo" column="LINE_NO"/>
        <result property="empNo" column="EMP_NO"/>
    </resultMap>

    <resultMap type="com.loung.semof.approval.dto.ApprovalDTO" id="approveResultMap">
        <id property="approvNo" column="APPROV_NO"/>
        <result property="approvTitle" column="APPROV_TITLE"/>
        <result property="approvDate" column="APPROV_DATE"/>
        <result property="empNo" column="EMP_NO"/>
        <result property="lineNo" column="LINE_NO"/>
        <collection property="ApprovFileDTOList" resultMap="fileResultMap"/>
        <collection property="ApprovContentDTOList" resultMap="contentResultMap"/>
        <collection property="ApprovStatusDTOList" resultMap="statusResultMap"/>
    </resultMap>
    <resultMap id="fileResultMap" type="com.loung.semof.approval.dto.ApprovFileDTO">
        <id property="fileNo" column="FILE_NO"/>
        <result property="originName" column="ORIGIN_NAME"/>
        <result property="newName" column="NEW_NAME"/>
        <result property="filePath" column="FILE_PATH"/>
        <result property="approvNo" column="APPROV_NO"/>
    </resultMap>
    <resultMap id="contentResultMap" type="com.loung.semof.approval.dto.ApprovContentDTO">
        <id property="contentNo" column="CONTENT_NO"/>
        <result property="content" column="CONTENT"/>
        <result property="formCode" column="FORM_CODE"/>
        <result property="approvNo" column="APPROV_NO"/>
        <result property="formTitle" column="FORM_TITLE"/>
    </resultMap>
    <resultMap id="statusResultMap" type="com.loung.semof.approval.dto.ApprovStatusDTO">
        <id property="statusNo" column="STATUS_NO"/>
        <result property="status" column="STATUS"/>
        <result property="approvNo" column="APPROV_NO"/>
    </resultMap>

    <!--    결재라인-->
    <!--    결재라인 추가-->
    <insert id = "insertApprovLine" parameterType="ApprovLineDTO">
        INSERT INTO TBL_APPROV_LINE
        (
         LINE_NAME
         ,BRANCH_CODE
        , EMP_NO
        )
        VALUES
            (
             #{ lineName }
            , #{ branchCode }
            , 3
            )
    </insert>
    <!--    결재라인 순서 등록-->
    <insert id = "insertApprovOrder" parameterType="ApprovOrderDTO">
        INSERT INTO TBL_APPROV_ORDER
        (
         LINE_NO
         , EMP_NO
        )
        VALUES (
                (SELECT LINE_NO FROM TBL_APPROV_LINE ORDER BY LINE_NO DESC LIMIT 1),
                #{ empNo }
                )
    </insert>

    <!--결재라인 조회-->
    <select id="selectApprovLineListWithPaging" resultType="ApprovLineDTO">
        SELECT
            A.*, B.*, te.*, tb.*
        FROM TBL_APPROV_LINE A
        JOIN TBL_APPROV_ORDER B
        ON A.LINE_NO = B.LINE_NO
        JOIN tbl_employee te
            on A.EMP_NO = te.EMP_NO
        JOIN tbl_branch tb
            on tb.BRANCH_CODE = A.BRANCH_CODE
        ORDER BY A.LINE_NO
    </select>

    <!--  등록된 결재라인 수 -->
    <select id="selectApprovLineTotal" resultType="int">
        SELECT
            count(*)
        FROM tbl_approv_line
    </select>

    <!--    결재라인수정-->
    <update id="updateApprovLine" parameterType="ApprovLineDTO">
        UPDATE TBL_APPROV_LINE
        SET
            LINE_NANE = #{lineName}
          , BRANCH_CODE = #{branchCode}
          , EMP_NO = #{empNo}
        WHERE LINE_NO=#{lineNo}
    </update>
    <!--    결재순서수정-->
    <update id="updateApprovOrder" parameterType="ApprovOrderDTO">
        UPDATE TBL_APPROV_ORDER
        SET
            EMP_NO = #{empNo}
        WHERE LINE_NO = #{lineNo}
          AND ORDER_NO = #{orderNo}
    </update>

    <!--    결재라인 삭제-->
    <delete id="deleteApprovLine" parameterType="ApprovLineDTO">
        DELETE
        FROM TBL_APPROV_LINE
        WHERE LINE_NO=#{lineNo}
    </delete>
    <!--    결재순서 삭제-->
<!--    <delete id="deleteApprovOrder" parameterType="ApprovOrderDTO">-->
<!--        DELETE-->
<!--        FROM TBL_APPROV_order-->
<!--        WHERE LINE_NO=#{lineNo}-->
<!--    </delete>-->


    <!--    결재문서-->
    <!--    결재상신-->
    <insert id="insertApproval" parameterType="ApprovalDTO">
        INSERT INTO TBL_APPROVAL
        (
         APPROV_TITLE
         , LINE_NO
        )
        VALUES
            (
           #{ approvTitle }
            ,#{ lineNo }
            )
    </insert>
    <insert id="insertApprovFile" parameterType="ApprovFileDTO">
        INSERT INTO TBL_APPROV_file
        (
         ORIGIN_NAME
         , NEW_NAME
         , FILE_PATH
         , APPROV_NO
        )
        VALUES
            (
            #{ originName }
            ,#{ newName }
            ,#{ filePath }
            ,#{ approvNo }
            )
    </insert>
    <insert id="insertApprovContent" parameterType="ApprovContentDTO">
        INSERT INTO TBL_APPROV_CONTENT
        (
            APPROV_CONTENT
        )
        VALUES
            (
            #{approvContent}
            )
    </insert>

    <!--    결재상신함-->
    <select id="selectApprovalInWithPaging" resultType="ApprovalDTO">
        SELECT P.APP_CATEGORY
             , P.APPROV_TITLE
             , LAST_VALUE(P.STATUS) OVER (
        RANGE BETWEEN
            	UNBOUNDED PRECEDING AND
            	UNBOUNDED FOLLOWING
	) STATUS
             , P.APPROV_DATE
        , P.e
        FROM (SELECT D.APP_CATEGORY
                   , A.APPROV_TITLE
                   , C.STATUS
                   , A.APPROV_DATE

                   ,F.EMP_NO as e


              FROM tbl_APPROVAL A
                       JOIN tbl_approv_content B
                            ON (A.APPROV_NO = B.APPROV_NO)
                       JOIN tbl_APPROV_STATUS C
                            ON (A.APPROV_NO = C.APPROV_NO)
                       JOIN tbl_approv_category D
                            ON (B.FORM_CODE = D.FORM_CODE)
                        JOIN tbl_approv_line E
                            ON (A.LINE_NO = E.LINE_NO)
                       JOIN tbl_approv_order F
                            ON (F.LINE_NO = E.LINE_NO)
                       JOIN tbl_employee G
                            ON (G.EMP_NO = A.EMP_NO)

             ) P
        WHERE P.e = 37

            LIMIT #{ startRow }
            , #{limit}
    </select>


<!--    완료된 결재상신-->
<!--    <select id="selectFinApprovalInWithPaging" resultType="ApprovalDTO">-->
<!--        SELECT P.APP_CATEGORY-->
<!--             , P.APPROV_TITLE-->
<!--             , LAST_VALUE(P.STATUS) OVER (-->
<!--        RANGE BETWEEN-->
<!--            	UNBOUNDED PRECEDING AND-->
<!--            	UNBOUNDED FOLLOWING-->
<!--	) STATUS-->
<!--             , P.APPROV_DATE-->
<!--        FROM (SELECT D.APP_CATEGORY-->
<!--                   , A.APPROV_TITLE-->
<!--                   , C.STATUS_NAME-->
<!--                   , A.APPROV_DATE-->
<!--                   ,E.ORDER_NO-->
<!--                   ,F.EMP_NO-->


<!--              FROM tbl_APPROVAL A-->
<!--                       JOIN tbl_approv_content B-->
<!--                            ON (A.APPROV_NO = B.APPROV_NO)-->
<!--                       JOIN tbl_APPROV_STATUS C-->
<!--                            ON (A.APPROV_NO = C.APPROV_NO)-->
<!--                       JOIN tbl_approv_category D-->
<!--                            ON (B.FORM_CODE = D.FORM_CODE)-->
<!--                       JOIN tbl_approv_order E-->
<!--                            ON (E.ORDER_NO = C.ORDER_NO)-->
<!--                       JOIN tbl_employee F-->
<!--                            ON (F.EMP_NO = A.EMP_NO)-->

<!--             ) P-->
<!--        WHERE P.EMP_NO = #{empNo}-->
<!--          AND STATUS = '승인'-->
<!--            LIMIT ${ startRow }-->
<!--            , #{ endRow }-->
<!--    </select>-->
<!--&lt;!&ndash;    결재수신함&ndash;&gt;-->
<!--    <select id="selectApprovalOutWithPaging" resultType="ApprovalDTO">-->
<!--        SELECT P.APP_CATEGORY-->
<!--             , P.APPROV_TITLE-->
<!--             , P.T-->
<!--             , P.APPROV_DATE-->
<!--        FROM (SELECT D.APP_CATEGORY-->
<!--                   , A.APPROV_TITLE-->
<!--                   , C.STATUS_NAME-->
<!--                   , A.APPROV_DATE-->
<!--                   ,E.ORDER_NO-->
<!--                   ,E.EMP_NO T-->
<!--                   ,F.EMP_NO G-->


<!--              FROM tbl_APPROVAL A-->
<!--                       JOIN tbl_approv_content B-->
<!--                            ON (A.APPROV_NO = B.APPROV_NO)-->
<!--                       JOIN tbl_APPROV_STATUS C-->
<!--                            ON (A.APPROV_NO = C.APPROV_NO)-->
<!--                       JOIN tbl_approv_category D-->
<!--                            ON (B.FORM_CODE = D.FORM_CODE)-->
<!--                       JOIN tbl_approv_order E-->
<!--                            ON (E.ORDER_NO = C.ORDER_NO)-->
<!--                       JOIN tbl_employee F-->
<!--                            ON (F.EMP_NO = A.EMP_NO)-->

<!--             ) P-->
<!--        WHERE P.G = #{empNo}-->
<!--            LIMIT ${ startRow }-->
<!--            , #{ endRow }-->
<!--    </select>-->
<!--&lt;!&ndash;    완료된 결재 수신&ndash;&gt;-->
<!--    <select id="selectFinApprovalOutWithPaging" resultType="ApprovalDTO">-->
<!--        SELECT P.APP_CATEGORY-->
<!--             , P.APPROV_TITLE-->
<!--             , P.T-->
<!--             , P.APPROV_DATE-->
<!--        FROM (SELECT D.APP_CATEGORY-->
<!--                   , A.APPROV_TITLE-->
<!--                   , C.STATUS_NAME-->
<!--                   , A.APPROV_DATE-->
<!--                   ,E.ORDER_NO-->
<!--                   ,E.EMP_NO T-->
<!--                   ,F.EMP_NO G-->


<!--              FROM tbl_APPROVAL A-->
<!--                       JOIN tbl_approv_content B-->
<!--                            ON (A.APPROV_NO = B.APPROV_NO)-->
<!--                       JOIN tbl_APPROV_STATUS C-->
<!--                            ON (A.APPROV_NO = C.APPROV_NO)-->
<!--                       JOIN tbl_approv_category D-->
<!--                            ON (B.FORM_CODE = D.FORM_CODE)-->
<!--                       JOIN tbl_approv_order E-->
<!--                            ON (E.ORDER_NO = C.ORDER_NO)-->
<!--                       JOIN tbl_employee F-->
<!--                            ON (F.EMP_NO = A.EMP_NO)-->

<!--             ) P-->
<!--        WHERE P.G = #{empNo}-->
<!--          AND STATUS = '승인'-->
<!--            LIMIT ${ startRow }-->
<!--            , #{ endRow }-->
<!--    </select>-->

    <!--페이징 처리를 위한 결재문서 개수 조회-->
    <select id="selectApprovalTotal" resultType="int">
        SELECT
            count(*)
        FROM tbl_approval
    </select>

    <!--    상신은 empNo로 수신은 수신도? 보여지는게 다르니까 나누자-->
    <!--    결재상세조회 -->
    <select id="selectApproval" resultType="ApprovalDTO">
        SELECT
            A.*, B.*, C.*, D.*
        FROM TBL_APPROVal A
                 JOIN TBL_APPROV_CONTENT B
                      ON A.APPROV_NO = B.APPROV_NO
                 JOIN TBL_APPROV_FILE C
                      ON A.APPROV_NO = C.APPROV_NO
                 JOIN TBL_APPROV_CATEGORY D
                      ON B.FORM_CODE = D.FORM_CODE
        WHERE A.APPROV_NO = #{approvNo}
    </select>

    <!--  결재수정  -->
    <update id="updateApproval" parameterType="ApprovalDTO">
<![CDATA[
        UPDATE TBL_APPROVal A
            JOIN tbl_approv_status B
        ON A.APPROV_NO = B.APPROV_NO
            SET
                APPROV_TITLE = #{approvTitle}
                    , APPROV_DATE = #{approvDate}
        WHERE APPROV_NO=#{approvNo}
        AND NOT EXISTS (
        SELECT 1
        FROM tbl_approv_status C
        WHERE A.APPROV_NO = C.APPROV_NO
        AND C.STATUS_CODE <> 'C'
        );
]]>
    </update>
    <update id="updateApprovFile" parameterType="ApprovFileDTO">
        UPDATE TBL_APPROV_file
        SET
            ORIGIN_NAME = #{originName}
          , NEW_NAME = #{newName}
          , FILE_PATH = #{filePath}
        WHERE APPROV_NO = #{approvNo}
          AND FILE_NO = #{fileNo}
    </update>
    <update id="updateContent" parameterType="ApprovContentDTO">
        UPDATE TBL_APPROV_content
        SET
            CONTENT = #{content}
        WHERE CONTENT_NO = #{contentNo}
          AND APPROV_NO = #{approvNo}
          AND FORM_CODE = #{formCode}
    </update>

    <!--결재삭제-->
    <delete id="deleteApproval" parameterType="_int">
        <![CDATA[
        DELETE A
        FROM TBL_APPROVal A
        JOIN tbl_approv_status B
        ON A.APPROV_NO = B.APPROV_NO
        WHERE A.APPROV_NO = #{approvNo}
        AND NOT EXISTS (
        SELECT 1
        FROM tbl_approv_status C
        WHERE A.APPROV_NO = C.APPROV_NO
        AND C.STATUS <> '미확인'
        );
        ]]>
    </delete>
    <!--    where절에 미확인-->
<!--    <delete id="deleteFile" parameterType="_int">-->
<!--        DELETE-->
<!--        FROM TBL_APPROV_file-->
<!--        WHERE APPROV_NO=#{approvNo}-->
<!--    </delete>-->
<!--    <delete id="deleteContent" parameterType="_int">-->
<!--        DELETE-->
<!--        FROM TBL_APPROV_content-->
<!--        WHERE APPROV_NO=#{approvNo}-->
<!--    </delete>-->

    <!--    완료된 결재-->
    <!--    상태 올 승인-->

    <!--    결재처리-->
    <update id="updateStatus" parameterType="ApprovStatusDTO">
        UPDATE TBL_APPROV_STATUS
        SET
            STATUS_CODE = #{statusCode}
          , STATUS_NAME = #{statusName}
        WHERE ORDER_NO = #{orderNo}
          AND APPROV_NO = #{approvNo}
    </update>
    <!--    결재의견작성-->
    <insert id="insertOpinion" parameterType="ApprovOpinDTO">
        INSERT INTO TBL_APPROV_opinion
        (
          OPIN_CONTENT
          , EMP_NO
          , APPROV_NO
        )
        VALUES
            (
           #{opinContent}
           ,#{empNo}
           ,#{approvNo}
            )
    </insert>
    <!--    댓글처럼-->
<!--    최종 상태값을 받아오는 쿼리-->
    <select id="selectLatestStatus" resultType="String">
        SELECT
            C.STATUS
        FROM TBL_APPROV_ORDER C
        WHERE ORDER_NO =
              (
                  SELECT
                      MAX(A.ORDER_NO)
                  FROM TBL_APPROV_ORDER A
                           JOIN TBL_APPROV_LINE B
                            ON A.LINE_NO = B.LINE_NO
                  WHERE A.LINE_NO = #{lineNo}
              )
    </select>

<!--    form title을 받아오는 쿼리 이게 이렇게 해도 되나...-->
    <select id="selectFormTitle" resultType="ApprovCategoryDTO">
        SELECT
            *
        FROM tbl_approv_category
    </select>
<!--    이번엔 부서명을 받아오는 메소드를 짤것-->
    <select id="selectBranch" resultType="BranchDto">
        SELECT
            *
        FROM tbl_branch
    </select>

    <select id="selectDepartment" resultType="DepartmentDto">
        SELECT
            *
        FROM tbl_department
    </select>
<!--    직급과 사원명을 담아오는 메소드-->
    <select id="selectJobNEmpName" resultType="HumanResourceDto">
        SELECT
            A.EMP_NO
            , A.EMP_NAME
            , B.*
        FROM tbl_employee A
        JOIN tbl_job B
        ON B.JOB_CODE = A.JOB_CODE
        JOIN tbl_branch tb on tb.BRANCH_CODE = A.BRANCH_CODE
        JOIN tbl_department td on td.DEPT_CODE = A.DEPT_CODE
        WHERE B.JOB_CODE NOT IN (1,7)
    </select>
<!--    <insert id="insertApprovLines" parameterType="java.util.List">-->
<!--        INSERT INTO approval_line (approv_id, approv_type, approv_order, user_id)-->
<!--        VALUES-->
<!--        <foreach collection="list" item="item" separator=",">-->
<!--            (#{item.approvId}, #{item.approvType}, #{item.approvOrder}, #{item.userId})-->
<!--        </foreach>-->
<!--    </insert>-->
<!--    <insert id="insertApprovOrders" parameterType="java.util.List">-->
<!--            INSERT INTO tbl_approv_order (LINE_NO, EMP_NO)-->
<!--            VALUES-->
<!--            <foreach collection='list' index='index' item='item' separator=','>-->
<!--                (#{item.lineNo}, #{item.empNo})-->
<!--            </foreach>-->
<!--    </insert>-->
<!--    <insert id="insertApprovOrders" parameterType="java.util.List">-->
<!--        INSERT INTO tbl_approv_order (LINE_NO, EMP_NO)-->
<!--        VALUES (?, ?, ?), (?, ?, ?), (?, ?, ?)-->
<!--    </insert>-->

    <insert id="insertLine" parameterType="ApprovLineDTO">
        INSERT INTO tbl_approv_line (LINE_NAME, EMP_NO, BRANCH_CODE)
        VALUES
            (#{lineName},3,#{branchCode})
    </insert>
</mapper>