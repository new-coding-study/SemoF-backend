<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.loung.semof.reply.dao.ReplyMapper">

    <resultMap id="replyResultMap" type="ReplyDto">
        <result column="REPLY_CODE" property="replyCode"/>
        <result column="REPLY_CONTENT" property="replyContent"/>
        <result column="BOARD_NO" property="boardNo"/>
        <result column="REPLY_WRITE_DATE" property="replyWriteDate" />
        <result column="EMP_NAME" property="empName" />
        <result column="EMP_NO" property="empNo"/>
    </resultMap>


    <select id="selectReply" resultType="ReplyDto">
        SELECT
            TR.REPLY_CODE
           ,TR.REPLY_CONTENT
           ,TR.BOARD_NO
           ,TE.EMP_NAME
        FROM tbl_reply TR
        JOIN tbl_board TB
        ON (TR.BOARD_NO = TB.BOARD_NO)
        JOIN tbl_employee TE
        ON (TR.EMP_NO = TE.EMP_NO)
        WHERE TR.BOARD_NO = #{boardNo}
        ORDER BY TR.REPLY_WRITE_DATE DESC
    </select>

    <select id="selectReplyTotal" resultType="int">
        SELECT
            count(*)
        FROM tbl_reply
        WHERE BOARD_NO =#{boardNo}
    </select>

    <select id="selectReplyWithPaging" resultType="ReplyDto">
        SELECT
            R.rowNum
           ,R.BOARD_NO
           ,R.EMP_NAME
           ,R.REPLY_CODE
           ,R.REPLY_CONTENT
           ,R.REPLY_WRITE_DATE
        FROM
        (SELECT
             ROW_NUMBER()OVER(ORDER BY TR.REPLY_WRITE_DATE DESC) AS rowNum
             ,TR.REPLY_CODE
             ,TR.REPLY_CONTENT
             ,TR.EMP_NO
             ,TR.BOARD_NO
             ,TE.EMP_NAME
             ,TR.REPLY_WRITE_DATE
        FROM tbl_reply TR
                 JOIN tbl_board TB
                      ON (TR.BOARD_NO = TB.BOARD_NO)
                 JOIN tbl_employee TE
                      ON (TR.EMP_NO = TE.EMP_NO)
        WHERE TR.BOARD_NO = #{boardNo}) R
        ORDER BY R.rowNum DESC
        LIMIT #{selectCriteria.startRow}, #{selectCriteria.endRow}
    </select>

    <insert id="insertReply" parameterType="String">
        INSERT INTO tbl_reply
            (REPLY_CONTENT
            , BOARD_NO
            , EMP_NO)
        VALUES
            (
             #{replyContent}
             ,#{boardNo}
             ,35
            )
    </insert>

    <update id="updateReply" parameterType="ReplyDto">
        UPDATE tbl_reply
        SET
            REPLY_CONTENT = #{replyContent}
        WHERE BOARD_NO = #{boardNo}
          AND EMP_NO = #{empNo}
          AND REPLY_CODE = #{replyCode}
    </update>

    <delete id="deleteForAdmin" parameterType="boardDto">
        DELETE FROM tbl_reply
        WHERE BOARD_NO = #{boardNo}
    </delete>

    <delete id="deleteForEmp" parameterType="boardDto">
        DELETE FROM tbl_reply
        WHERE BOARD_NO = #{boardNo}
          AND EMP_NO = #{empNo}
    </delete>

</mapper>